\environment env_cards

\starttext

\tolerance 9999
\emergencystretch 3em
\vfuzz\hfuzz

% https://tex.stackexchange.com/a/673819
\definelayer[cardicons][x=\dimexpr\backspace-\leftmarginwidth-\leftmargindistance,width=\dimexpr\paperwidth+\rightmargindistance+\rightmarginwidth,y=\dimexpr\topspace-\headerheight-\headerdistance,height=\dimexpr\paperheight-\footerdistance-\footerheight]

\setupexternalfigures[order={pdf,png,svg},location=global,directory={gameicons}]

\setupbackgrounds[page][background=cardicons]

<% cards.forEach(function(card) { -%>

<% for (let i = 0; i < card.quantity; i++) { -%>

% Back

<% if (card.deck.icon) { -%>
\setlayer[cardicons][preset=lefttop]{\externalfigure[<%- card.deck.icon -%>.svg][width=1cm,height=1cm]}
<% } -%>
<% if (card.stack.icon) { -%>
\setlayer[cardicons][preset=righttop]{\externalfigure[<%- card.stack.icon -%>.svg][width=1cm,height=1cm]}
<% } -%>

\constellationtitle{<%- card.back.name -%>}
\constellationstack{<%- card.stack.name -%>}

<% if (card.back.flavor) { -%>
\constellationquote{<%- card.back.flavor -%>}
<% }; -%>

<%- description(card.back.description) -%>

<% if (card.back.prompts) { -%>
\startitemize[nowhite]
<% card.back.prompts.forEach(function(prompt) { -%>
\item <%- prompt %>
<% }); -%>
\stopitemize
<% }; -%>

\vfill

\constellationrule{BACK: <%- card.back.rule -%>}

\page

% Front

<% if (card.deck.icon) { -%>
\setlayer[cardicons][preset=lefttop]{\externalfigure[<%- card.deck.icon -%>.svg][width=1cm,height=1cm]}
<% } -%>
<% if (card.stack.icon) { -%>
\setlayer[cardicons][preset=righttop]{\externalfigure[<%- card.stack.icon -%>.svg][width=1cm,height=1cm]}
<% } -%>

\constellationtitle{<%- card.front.name -%>}
\constellationstack{<%- card.stack.name -%>}

<% if (card.front.flavor) { -%>
\constellationquote{<%- card.front.flavor -%>}
<% }; -%>

<%- description(card.front.description) -%>

<% if (card.front.prompts) { -%>
\startitemize[nowhite]
<% card.front.prompts.forEach(function(prompt) { -%>
\item <%- prompt %>
<% }); -%>
\stopitemize
<% }; -%>

\vfill

\constellationrule{FRONT: <%- card.front.rule -%>}

\page

<% }; }); -%>

\stoptext
